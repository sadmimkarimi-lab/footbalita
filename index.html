<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <title>ÙÙˆØªØ¨Ø§Ù„ÛŒØªØ§ âš½ | Ù†Ø³Ø®Ù‡ Ù¾Ø±Ùˆ</title>

  <!-- Eitaa WebApp SDK -->
  <script src="https://developer.eitaa.com/eitaa-web-app.js"></script>

  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    html,body{height:100%;background:#070b14;color:#fff;overflow:hidden}

    :root{
      --fs-xs: clamp(12px, 2.2vw, 14px);
      --fs-sm: clamp(13px, 2.35vw, 15px);
      --fs-md: clamp(14px, 2.6vw, 17px);
      --fs-lg: clamp(16px, 3.0vw, 20px);
      --fs-xl: clamp(20px, 4.6vw, 34px);
      --fs-xxl: clamp(24px, 5.8vw, 44px);
      --radius: 18px;
    }
    body{font-size:var(--fs-md);}

    .app{height:100%;display:flex;flex-direction:column;max-width:680px;margin:0 auto;padding:6px;gap:6px}
    .glass{
      background:rgba(255,255,255,.085);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:6px 8px;
      backdrop-filter:blur(10px);
      box-shadow:0 10px 34px rgba(0,0,0,.22);
    }

    .topbar{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .brand{display:flex;align-items:center;gap:8px;min-width:0}
    .logo{
      width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center;
      background:rgba(34,197,94,.22);border:1px solid rgba(34,197,94,.35);
      box-shadow:0 0 18px rgba(34,197,94,.14);
      font-size:16px;flex:0 0 auto;
      animation:logoFloat 3s ease-in-out infinite;
    }
    @keyframes logoFloat{
      0%,100%{transform:translateY(0px) rotate(0deg)}
      50%{transform:translateY(-3px) rotate(5deg)}
    }
    .titles{display:flex;flex-direction:column;gap:1px;min-width:0}
    .name{font-weight:1000;font-size:clamp(14px, 2.9vw, 18px);line-height:1.1;letter-spacing:.2px}
    .tag{opacity:.88;font-size:clamp(12px, 2.3vw, 14px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:360px}

    .btn{
      border:none;border-radius:14px;padding:9px 11px;font-weight:1000;cursor:pointer;
      background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.14);
      font-size:clamp(12px, 2.3vw, 14px);line-height:1;user-select:none;white-space:nowrap;
      transition:all .15s ease;
    }
    .btn:active{transform:scale(.96)}
    .btn.primary{background:linear-gradient(135deg,#22c55e,#a3e635);color:#071022;border:none;box-shadow:0 4px 12px rgba(34,197,94,.3)}
    .btn.danger{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.35)}
    .btn.icon{padding:9px 10px;min-width:44px;text-align:center;font-size:clamp(14px, 2.8vw, 16px)}
    .btn.pill{border-radius:999px}
    .modeBtn.active{background:rgba(34,197,94,.22);border-color:rgba(34,197,94,.35);box-shadow:0 0 12px rgba(34,197,94,.2)}

    .panel{display:flex;gap:6px;align-items:center;justify-content:space-between}
    .modes{display:flex;gap:6px;flex-wrap:nowrap}

    .hud{
      display:flex;align-items:center;justify-content:space-between;gap:6px
    }
    .pills{display:flex;gap:6px;align-items:center;flex-wrap:nowrap;overflow:auto;scrollbar-width:none}
    .pills::-webkit-scrollbar{display:none}
    .pill{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      padding:7px 10px;border-radius:999px;font-weight:1000;font-size:clamp(12px, 2.3vw, 14px);
      display:flex;gap:6px;align-items:center;white-space:nowrap;
      transition:all .2s ease;
    }
    .pill strong{font-size:clamp(13px, 2.5vw, 16px)}
    .scorePill{
      padding:4px 9px;
      border-color:rgba(255,255,255,.18);
      background:rgba(255,255,255,.09);
    }
    .scoreGreen{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.12)}
    .scoreBlue{border-color:rgba(59,130,246,.35);background:rgba(59,130,246,.12)}
    
    .pill.pulse{animation:pillPulse .5s ease}
    @keyframes pillPulse{
      0%,100%{transform:scale(1)}
      50%{transform:scale(1.08)}
    }

    .stage{
      flex:1;min-height:0;border-radius:18px;overflow:hidden;border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(1200px 600px at 50% 90%, rgba(34,197,94,.18), transparent 60%),
        radial-gradient(900px 400px at 50% 15%, rgba(59,130,246,.10), transparent 60%),
        linear-gradient(180deg,#0f1830,#071022);
      position:relative;box-shadow:0 18px 70px rgba(0,0,0,.55)
    }
    canvas{width:100%;height:100%;display:block;touch-action:none}

    .hint{
      opacity:.92;font-size:clamp(12px, 2.35vw, 14px);text-align:center;line-height:1.75;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;padding:6px 8px;
    }

    .toast{
      position:fixed;left:50%;top:9%;transform:translateX(-50%);
      background:rgba(0,0,0,.58);border:1px solid rgba(255,255,255,.12);
      padding:12px 14px;border-radius:14px;z-index:99999;
      font-weight:1000;font-size:clamp(13px, 2.6vw, 16px);opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      max-width:min(92vw,560px);text-align:center;direction:rtl
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:14px;background:rgba(0,0,0,.62);z-index:9999;backdrop-filter:blur(4px)}
    .card{
      width:min(520px,100%);background:linear-gradient(180deg,#0f1a33,#0a1124);
      border:1px solid rgba(255,255,255,.12);border-radius:16px;
      box-shadow:0 25px 80px rgba(0,0,0,.6);padding:12px;
      animation:cardPop .25s ease;
    }
    @keyframes cardPop{
      0%{transform:scale(.92);opacity:0}
      100%{transform:scale(1);opacity:1}
    }
    .card h3{margin:0 0 6px;font-size:14px}
    .card p{margin:0 0 10px;font-size:11px;opacity:.92;line-height:1.9}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row .btn{flex:1}
    .muted{opacity:.85;font-size:10px}

    .goalFx{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.36);z-index:9998;backdrop-filter:blur(2px)}
    .goalFxText{
      padding:14px 18px;border-radius:18px;
      background:linear-gradient(135deg, rgba(34,197,94,.95), rgba(163,230,53,.95));
      color:#071022;font-weight:1000;font-size:28px;
      box-shadow:0 18px 80px rgba(0,0,0,.45);
      text-align:center;
      animation:goalBounce .4s ease;
    }
    @keyframes goalBounce{
      0%{transform:scale(.7);opacity:0}
      60%{transform:scale(1.12)}
      100%{transform:scale(1);opacity:1}
    }
    @keyframes shake{0%{transform:translate(0,0)}25%{transform:translate(2px,-2px)}50%{transform:translate(-2px,2px)}75%{transform:translate(2px,2px)}100%{transform:translate(0,0)}}
    .goal-shake{animation:shake .28s linear}

    .confetti{position:fixed;pointer-events:none;z-index:9997}

    .bottom-ad{
      position:fixed;left:50%;bottom:6px;
      width:min(96%,580px);height:46px;display:none;align-items:center;justify-content:center;
      z-index:99999;border-radius:14px;background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(8px);
      box-shadow:0 12px 50px rgba(0,0,0,.45);overflow:hidden;
      opacity:0;
      transform:translateX(-50%) translateY(10px) scale(.985);
      transition:opacity .22s ease, transform .22s ease;
      pointer-events:none;
    }
    .bottom-ad.show{
      opacity:1;
      transform:translateX(-50%) translateY(0) scale(1);
      pointer-events:auto;
    }
    .bottom-ad img{height:100%;width:100%;object-fit:cover;cursor:pointer}
    .closeAd{
      position:absolute;right:6px;top:6px;width:20px;height:20px;border:none;border-radius:999px;
      background:rgba(0,0,0,.55);color:#fff;font-size:14px;line-height:20px;cursor:pointer;
    }
    .adTag{
      position:absolute;left:8px;top:7px;background:rgba(249,115,22,.92);
      color:#071022;font-weight:1000;border-radius:999px;padding:2px 7px;font-size:10px;
    }

    .tiny{font-size:10px;opacity:.9}
    
    .powerMeter{
      position:absolute;left:50%;bottom:20px;transform:translateX(-50%);
      width:200px;height:8px;background:rgba(0,0,0,.4);
      border-radius:999px;border:1px solid rgba(255,255,255,.2);
      overflow:hidden;opacity:0;pointer-events:none;
      transition:opacity .2s ease;
    }
    .powerMeter.show{opacity:1}
    .powerBar{
      height:100%;background:linear-gradient(90deg,#22c55e,#a3e635,#f59e0b,#ef4444);
      border-radius:999px;width:0%;transition:width .05s linear;
      box-shadow:0 0 10px rgba(34,197,94,.6);
    }

    .combo-display{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      font-size:48px;font-weight:1000;
      color:#fff;
      text-shadow:0 0 20px rgba(34,197,94,.8),0 0 40px rgba(34,197,94,.5);
      opacity:0;
      pointer-events:none;
      transition:opacity .3s ease;
    }
    .combo-display.show{
      opacity:1;
      animation:comboZoom .5s ease;
    }
    @keyframes comboZoom{
      0%{transform:translate(-50%,-50%) scale(.5)}
      50%{transform:translate(-50%,-50%) scale(1.2)}
      100%{transform:translate(-50%,-50%) scale(1)}
    }

    .eventBanner{
      position:fixed;
      left:50%;
      top:22%;
      transform:translate(-50%,-50%) scale(.86);
      opacity:0;
      z-index:100000;
      pointer-events:none;
      padding:14px 18px;
      border-radius:18px;
      text-align:center;
      direction:rtl;
      font-weight:1000;
      font-size:var(--fs-xxl);
      letter-spacing:.2px;
      text-shadow:0 10px 30px rgba(0,0,0,.65), 0 0 22px rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.14);
      backdrop-filter:blur(8px);
      box-shadow:0 18px 90px rgba(0,0,0,.55);
      max-width:min(92vw, 620px);
      line-height:1.15;
    }
    .eventBanner.neutral{background:rgba(0,0,0,.55)}
    .eventBanner.good{
      background:linear-gradient(135deg, rgba(34,197,94,.92), rgba(163,230,53,.92));
      color:#071022;border:none;
      box-shadow:0 20px 120px rgba(34,197,94,.30);
      text-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .eventBanner.warn{
      background:linear-gradient(135deg, rgba(249,115,22,.92), rgba(250,204,21,.92));
      color:#071022;border:none;
      box-shadow:0 20px 120px rgba(249,115,22,.25);
      text-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .eventBanner.bad{
      background:linear-gradient(135deg, rgba(239,68,68,.92), rgba(244,63,94,.92));
      color:#071022;border:none;
      box-shadow:0 20px 120px rgba(239,68,68,.22);
      text-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .eventBanner.show{
      opacity:1;
      animation:eventPop .95s ease forwards;
    }
    @keyframes eventPop{
      0%{opacity:0;transform:translate(-50%,-50%) scale(.65)}
      14%{opacity:1;transform:translate(-50%,-50%) scale(1.06)}
      55%{opacity:1;transform:translate(-50%,-50%) scale(1)}
      100%{opacity:0;transform:translate(-50%,-68%) scale(.96)}
    }

    /* --- UI polish + PvP theater mode --- */
    .btn.primary{
      position:relative;
      overflow:hidden;
    }
    .btn.primary::after{
      content:"";
      position:absolute; inset:-40% -60%;
      background:radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 45%);
      transform:translateX(-35%) rotate(10deg);
      opacity:.28;
      animation:primaryGlow 2.8s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes primaryGlow{
      0%,100%{transform:translateX(-45%) rotate(10deg); opacity:.18}
      50%{transform:translateX(35%) rotate(10deg); opacity:.32}
    }

    body.pvp-full .topbar,
    body.pvp-full .panel,
    body.pvp-full .hud,
    body.pvp-full .hint { display:none !important; }

    body.pvp-full .app{ max-width:100%; padding:0; gap:0; }
    body.pvp-full .stage{
      position:fixed; inset:0;
      border-radius:0;
      z-index:9990;
      border:none;
    }
    .pvpBackBtn{
      position:fixed;
      top:10px;
      left:10px;
      z-index:9991;
      display:none;
    }
    .pvpBackBtn.show{display:block;}

  </style>
</head>

<body>
<div class="app">
  <div class="topbar glass">
    <div class="brand">
      <div class="logo">âš½</div>
      <div class="titles">
        <div class="name">ÙÙˆØªØ¨Ø§Ù„ÛŒØªØ§ Ù¾Ø±Ùˆ</div>
        <div class="tag">Ù†Ø³Ø®Ù‡ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ | ÙÛŒØ²ÛŒÚ© ÙˆØ§Ù‚Ø¹ÛŒ + Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ ğŸ”¥</div>
      </div>
    </div>
    <button class="btn" id="tavitaBtn">Ø·Ø§ÙˆÛŒØªØ§</button>
  </div>

  <div class="panel glass">
    <div class="modes">
      <button class="btn pill modeBtn active" data-mode="solo">ğŸ¯ Ù¾Ù†Ø§Ù„ØªÛŒ</button>
      <button class="btn pill modeBtn" data-mode="pvp">ğŸ‘¥ Ø¯ÙˆÙ†ÙØ±Ù‡</button>
    </div>

    <div style="display:flex;gap:6px;align-items:center;flex-wrap:nowrap">
      <button class="btn icon" id="soundBtn" title="ØµØ¯Ø§">ğŸ”Š</button>
      <button class="btn icon" id="pauseBtn" title="Ù…Ú©Ø«">â¸</button>
      <button class="btn primary" id="restartBtn" title="Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯">â†»</button>
    </div>
  </div>

  <div class="hud glass">
    <div class="pills" id="hudLeft">
      <div class="pill scorePill scoreGreen" id="p1Pill">ğŸŸ¢ <strong id="p1Score">0</strong><span class="tiny">Ø§Ù…ØªÛŒØ§Ø²</span></div>
      <div class="pill scorePill scoreBlue" id="p2Pill" style="display:none;">ğŸ”µ <strong id="p2Score">0</strong><span class="tiny">Ø¨Ø§Ø²ÛŒÚ©Ù† Û²</span></div>
      <div class="pill">âš½ Ú¯Ù„â€ŒÙ‡Ø§: <strong id="goals">0</strong></div>
      <div class="pill" id="streakPill">ğŸ”¥ Ø§Ø³ØªØ±ÛŒÚ©: <strong id="streak">0</strong>x</div>
      <div class="pill">â± <strong id="time">60</strong>s</div>
    </div>
    <div class="pill" id="modeLabel">Ù¾Ù†Ø§Ù„ØªÛŒ</div>
  </div>

  <div class="stage">
    <canvas id="cv"></canvas>
    <div class="powerMeter" id="powerMeter">
      <div class="powerBar" id="powerBar"></div>
    </div>
    <div class="combo-display" id="comboDisplay"></div>
  </div>

  <div class="hint glass" id="hint">
    Ø±ÙˆÛŒ ØªÙˆÙ¾ Ø¨Ú©Ø´ Ùˆ Ø±Ù‡Ø§ Ú©Ù† ğŸ¯ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ØªØ±ÛŒÙ† Ù‡Ø¯Ù!
  </div>
</div>

<button class="btn pvpBackBtn" id="pvpBackBtn">â¬…ï¸ Ø¨Ø±Ú¯Ø´Øª</button>

<div class="toast" id="toast"></div>
<div class="eventBanner neutral" id="eventBanner"></div>

<div class="overlay" id="pauseOverlay">
  <div class="card">
    <h3 id="overlayTitle">Ù…Ú©Ø« â¸</h3>
    <p id="overlayDesc" class="muted">ØªØ¨Ù„ÛŒØº ÙÙ‚Ø· Ø¯Ø± Ù…Ú©Ø«/Ú¯Ù„/Ù¾Ø§ÛŒØ§Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ âœ…</p>
    <div class="row">
      <button class="btn primary" id="resumeBtn">Ø§Ø¯Ø§Ù…Ù‡</button>
      <button class="btn" id="closePauseBtn">Ø¨Ø³ØªÙ†</button>
    </div>
  </div>
</div>

<div class="goalFx" id="goalFx">
  <div class="goalFxText" id="goalFxText">GOOOAL! âš½ğŸ”¥</div>
</div>

<div id="bottomAd" class="bottom-ad" aria-hidden="true">
  <span class="adTag">Ø§Ø³Ù¾Ø§Ù†Ø³Ø±</span>
  <img id="bottomAdImg" alt="ad">
  <button class="closeAd" id="closeAdBtn" title="Ø¨Ø³ØªÙ†">Ã—</button>
</div>

<script>
(() => {
  // ==================== Eitaa SDK ====================
  const EWA = (window.Eitaa && window.Eitaa.WebApp) ? window.Eitaa.WebApp : null;
  try{
    if(EWA){
      if(typeof EWA.ready==="function") EWA.ready();
      if(typeof EWA.expand==="function") EWA.expand();
      if(typeof EWA.disableVerticalSwipes==="function") EWA.disableVerticalSwipes();
    }
  }catch(e){}

  function openEitaaLinkSafe(url){
    const isEitaa = /^https?:\/\/(www\.)?eitaa\.com\//i.test(url);
    try{
      if(EWA){
        if(isEitaa && typeof EWA.openEitaaLink==="function"){ EWA.openEitaaLink(url); return; }
        if(typeof EWA.openLink==="function"){ EWA.openLink(url); return; }
        if(typeof EWA.openEitaaLink==="function"){ EWA.openEitaaLink(url); return; }
      }
    }catch(e){}
    try{ window.location.assign(url); }catch(e){ window.location.href=url; }
  }

  // ==================== Ads ====================
  const ADS = {
    enabled:true,
    image:"https://cdnfa.com/irangiah/a9be/uploads/ads/tankads.webp",
    link:"https://eitaa.com/tavita_ads",
    autoHideMs:5200,
    minGapSec:14,
    showOnPause:true,
    showOnGoal:true,
    showOnTimeEnd:true,
    showOnWin:true
  };

  const bottomAd = document.getElementById("bottomAd");
  const bottomAdImg = document.getElementById("bottomAdImg");
  const closeAdBtn = document.getElementById("closeAdBtn");
  bottomAdImg.src = ADS.image;

  let adTimer=null;
  function adKey(k){ return "footballita_ad_" + k; }
  function canShowAd(){
    try{
      const last = parseInt(localStorage.getItem(adKey("last")) || "0", 10);
      return (Date.now()-last) >= (ADS.minGapSec*1000);
    }catch(e){ return true; }
  }
  function markShown(){ try{ localStorage.setItem(adKey("last"), String(Date.now())); }catch(e){} }

  function showAd(){
    if(!ADS.enabled) return;
    if(!canShowAd()) return;
    markShown();
    bottomAd.style.display="flex";
    bottomAd.setAttribute("aria-hidden","false");
    requestAnimationFrame(()=>bottomAd.classList.add("show"));
    clearTimeout(adTimer);
    adTimer=setTimeout(hideAd, ADS.autoHideMs);
  }
  function hideAd(){
    bottomAd.classList.remove("show");
    bottomAd.setAttribute("aria-hidden","true");
    clearTimeout(adTimer);
    setTimeout(()=>{ bottomAd.style.display="none"; }, 240);
  }
  bottomAdImg.addEventListener("click", ()=>openEitaaLinkSafe(ADS.link));
  closeAdBtn.addEventListener("click",(e)=>{ e.stopPropagation(); hideAd(); });

  // ==================== UI ====================
  const ui = {
    tavitaBtn: document.getElementById("tavitaBtn"),
    soundBtn: document.getElementById("soundBtn"),
    pauseBtn: document.getElementById("pauseBtn"),
    restartBtn: document.getElementById("restartBtn"),
    resumeBtn: document.getElementById("resumeBtn"),
    closePauseBtn: document.getElementById("closePauseBtn"),
    pauseOverlay: document.getElementById("pauseOverlay"),
    overlayTitle: document.getElementById("overlayTitle"),
    overlayDesc: document.getElementById("overlayDesc"),
    modeBtns: [...document.querySelectorAll(".modeBtn")],
    modeLabel: document.getElementById("modeLabel"),
    hint: document.getElementById("hint"),
    p1Score: document.getElementById("p1Score"),
    p2Score: document.getElementById("p2Score"),
    p2Pill: document.getElementById("p2Pill"),
    p1Pill: document.getElementById("p1Pill"),
    goals: document.getElementById("goals"),
    streak: document.getElementById("streak"),
    streakPill: document.getElementById("streakPill"),
    time: document.getElementById("time"),
    powerMeter: document.getElementById("powerMeter"),
    powerBar: document.getElementById("powerBar"),
    comboDisplay: document.getElementById("comboDisplay"),
    eventBanner: document.getElementById("eventBanner"),
  };

  ui.tavitaBtn.addEventListener("click", ()=>openEitaaLinkSafe("https://eitaa.com/tavita"));

  // toast
  const toastEl=document.getElementById("toast");
  let toastTimer=null;
  function toast(t){
    toastEl.textContent=t;
    toastEl.classList.add("show");
    clearTimeout(toastTimer);
    toastTimer=setTimeout(()=>toastEl.classList.remove("show"),980);
  }

  // Big event banner
  let eventTimer=null;
  function hype(msg, tone="neutral", ms=920){
    if(!ui.eventBanner) return toast(msg);
    ui.eventBanner.textContent = msg;
    ui.eventBanner.classList.remove("good","warn","bad","neutral","show");
    ui.eventBanner.classList.add(tone || "neutral");
    void ui.eventBanner.offsetWidth;
    ui.eventBanner.classList.add("show");
    clearTimeout(eventTimer);
    eventTimer=setTimeout(()=>ui.eventBanner.classList.remove("show"), ms);
  }

  // Combo display
  function showCombo(text){
    ui.comboDisplay.textContent=text;
    ui.comboDisplay.classList.add("show");
    setTimeout(()=>ui.comboDisplay.classList.remove("show"), 800);
  }

  // Goal FX
  const goalFx=document.getElementById("goalFx");
  const goalFxText=document.getElementById("goalFxText");
  const stageEl=document.querySelector(".stage");
  const pvpBackBtn = document.getElementById("pvpBackBtn");

  function enterPvpFullscreen(){
    document.body.classList.add("pvp-full");
    if(pvpBackBtn) pvpBackBtn.classList.add("show");
    try{
      if(stageEl && stageEl.requestFullscreen) stageEl.requestFullscreen();
    }catch(e){}
    resize();
  }

  function exitPvpFullscreen(){
    document.body.classList.remove("pvp-full");
    if(pvpBackBtn) pvpBackBtn.classList.remove("show");
    try{
      if(document.fullscreenElement && document.exitFullscreen) document.exitFullscreen();
    }catch(e){}
    resize();
  }

  let slowmo=1;

  if(pvpBackBtn){
    pvpBackBtn.addEventListener("click", ()=>{
      exitPvpFullscreen();
      setMode(MODES.solo);
    });
  }
  
  function createConfetti(){
    const colors = ['#22c55e','#a3e635','#fbbf24','#f59e0b','#3b82f6','#8b5cf6','#ec4899'];
    for(let i=0;i<80;i++){
      const conf = document.createElement('div');
      conf.className = 'confetti';
      const size = 6 + Math.random()*6;
      conf.style.cssText = `
        position:fixed;
        left:${Math.random()*100}%;
        top:-20px;
        width:${size}px;
        height:${size}px;
        background:${colors[Math.floor(Math.random()*colors.length)]};
        opacity:${0.7+Math.random()*0.3};
        border-radius:${Math.random()>0.5?'50%':'2px'};
        transform:rotate(${Math.random()*360}deg);
      `;
      document.body.appendChild(conf);
      
      const duration = 2500 + Math.random()*1500;
      const endY = window.innerHeight + 100;
      const endX = parseFloat(conf.style.left) + (Math.random()*300-150);
      
      conf.animate([
        {transform:`translate(0,0) rotate(0deg)`, opacity:1},
        {transform:`translate(${endX}px,${endY/2}px) rotate(${Math.random()*360}deg)`, opacity:0.8, offset:0.5},
        {transform:`translate(${endX}px,${endY}px) rotate(${Math.random()*720}deg)`, opacity:0}
      ], {
        duration,
        easing:'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
      }).onfinish = ()=>conf.remove();
    }
  }
  
  function goalHype(text){
    goalFxText.textContent=text||"GOOOAL! âš½ğŸ”¥";
    goalFx.style.display="flex";
    stageEl.classList.add("goal-shake");
    setTimeout(()=>stageEl.classList.remove("goal-shake"),300);
    slowmo=0.5; setTimeout(()=>slowmo=1,600);
    createConfetti();
    if(ADS.showOnGoal) showAd();
    sfxGoal(); vibr(40);
    setTimeout(()=>goalFx.style.display="none",700);
  }

  // Sound system
  let soundOn=true;
  let AC=null;
  function getAC(){ try{ if(!AC) AC=new (window.AudioContext||window.webkitAudioContext)(); return AC; }catch(e){ return null; } }
  
  function beep(freq=740,dur=0.06,vol=0.03,type="sine"){
    if(!soundOn) return;
    const ac=getAC(); if(!ac) return;
    try{
      const o=ac.createOscillator(), g=ac.createGain();
      o.connect(g); g.connect(ac.destination);
      o.frequency.value=freq; o.type=type;
      g.gain.setValueAtTime(vol,ac.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime+dur);
      o.start(); o.stop(ac.currentTime+dur);
    }catch(e){}
  }
  
  function vibr(ms=16){ try{ navigator.vibrate && navigator.vibrate(ms); }catch(e){} }
  function sfxKick(){ 
    beep(600,0.055,0.04,"triangle"); 
    setTimeout(()=>beep(450,0.035,0.025,"sine"),25);
  }
  function sfxSave(){ 
    beep(220,0.110,0.035,"sawtooth");
    setTimeout(()=>beep(180,0.08,0.028,"square"),60);
  }
  function sfxMiss(){ beep(165,0.120,0.032,"square"); }
  function sfxPost(){ 
    beep(380,0.065,0.040,"square"); 
    setTimeout(()=>beep(280,0.075,0.035,"square"),80);
  }
  function sfxGoal(){ 
    beep(1100,0.095,0.035,"triangle"); 
    setTimeout(()=>beep(1380,0.095,0.032,"triangle"),100);
    setTimeout(()=>beep(1650,0.095,0.029,"triangle"),200);
    setTimeout(()=>beep(1980,0.110,0.026,"sine"),300);
  }

  ui.soundBtn.addEventListener("click", ()=>{ soundOn=!soundOn; syncUI(); toast(soundOn?"ğŸ”Š ØµØ¯Ø§ Ø±ÙˆØ´Ù†":"ğŸ”‡ ØµØ¯Ø§ Ø®Ø§Ù…ÙˆØ´"); });

  // ==================== pause / overlay ====================
  let paused=false, running=true, inEndScreen=false;
  let overlayType="pause";

  function openOverlay(title, desc, type){
    overlayType = type || "pause";
    ui.overlayTitle.textContent=title;
    ui.overlayDesc.textContent=desc || " ";
    ui.pauseOverlay.style.display="flex";
    ui.resumeBtn.textContent = (overlayType==="end") ? "Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯" : "Ø§Ø¯Ø§Ù…Ù‡";
  }
  function closeOverlay(){ ui.pauseOverlay.style.display="none"; }

  function openPause(){
    paused=true; inEndScreen=false;
    openOverlay("Ù…Ú©Ø« â¸","ØªØ¨Ù„ÛŒØº ÙÙ‚Ø· Ø¯Ø± Ù…Ú©Ø«/Ú¯Ù„/Ù¾Ø§ÛŒØ§Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ âœ…","pause");
    syncUI();
    if(ADS.showOnPause) showAd();
  }

  function hardRestart(){
    closeOverlay();
    hideAd();
    paused=false; running=true; inEndScreen=false;
    timeLeft=60;
    if(mode===MODES.solo) soloResetAll(); else pvpResetAll();
    syncUI();
  }

  function resume(){
    if(overlayType==="end" || inEndScreen || !running){
      hardRestart();
      return;
    }
    closeOverlay(); paused=false; inEndScreen=false;
    hideAd(); syncUI();
  }

  ui.pauseBtn.addEventListener("click", ()=> paused ? resume() : openPause());
  ui.resumeBtn.addEventListener("click", resume);
  ui.closePauseBtn.addEventListener("click", ()=>{ closeOverlay(); hideAd(); });
  ui.pauseOverlay.addEventListener("click",(e)=>{ if(e.target===ui.pauseOverlay){ closeOverlay(); hideAd(); } });

  // ==================== Canvas ====================
  const cv=document.getElementById("cv");
  const ctx=cv.getContext("2d");
  let W=0,H=0,DPR=1;

  function resize(){
    const r=cv.getBoundingClientRect();
    DPR=Math.min(2, window.devicePixelRatio||1);
    W=Math.max(10, r.width);
    H=Math.max(10, r.height);
    cv.width=Math.floor(W*DPR);
    cv.height=Math.floor(H*DPR);
    ctx.setTransform(DPR,0,0,DPR,0,0);
    computeSizes();
  }
  addEventListener("resize", resize);

  function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }
  function dist(ax,ay,bx,by){ return Math.hypot(ax-bx, ay-by); }
  function circleRectHit(cx,cy,cr, rx,ry,rw,rh){
    const nx=clamp(cx,rx,rx+rw);
    const ny=clamp(cy,ry,ry+rh);
    return dist(cx,cy,nx,ny) <= cr;
  }
  function toLocal(e){
    const r=cv.getBoundingClientRect();
    return {x:e.clientX-r.left, y:e.clientY-r.top};
  }

  // ==================== Draw helpers ====================
  function drawSoccerBall(x,y,r,spin=0){
    ctx.save(); 
    ctx.translate(x,y); 
    ctx.rotate(spin*0.4);

    ctx.globalAlpha=0.4;
    ctx.fillStyle="#000";
    ctx.beginPath(); 
    ctx.arc(r*0.2,r*0.2,r*1.1,0,Math.PI*2); 
    ctx.fill();
    ctx.globalAlpha=1;

    const glowGrad = ctx.createRadialGradient(0,0,r*0.8,0,0,r*1.3);
    glowGrad.addColorStop(0,"transparent");
    glowGrad.addColorStop(0.7,"transparent");
    glowGrad.addColorStop(1,"rgba(255,255,255,.15)");
    ctx.fillStyle=glowGrad;
    ctx.beginPath(); 
    ctx.arc(0,0,r*1.3,0,Math.PI*2); 
    ctx.fill();

    const base=ctx.createRadialGradient(-r*0.4,-r*0.5,r*0.1,0,0,r);
    base.addColorStop(0,"#ffffff");
    base.addColorStop(0.4,"#f8fafc");
    base.addColorStop(0.7,"#e2e8f0");
    base.addColorStop(1,"#cbd5e1");
    ctx.fillStyle=base;
    ctx.beginPath(); 
    ctx.arc(0,0,r,0,Math.PI*2); 
    ctx.fill();

    ctx.lineWidth=Math.max(1.5, r*0.07);
    ctx.strokeStyle="rgba(15,23,42,.60)";
    ctx.fillStyle="#0f172a";

    ctx.beginPath();
    for(let i=0;i<5;i++){
      const a=-Math.PI/2+i*(Math.PI*2/5);
      const px=Math.cos(a)*r*0.28, py=Math.sin(a)*r*0.28;
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.closePath(); 
    ctx.fill(); 
    ctx.stroke();

    for(let k=0;k<5;k++){
      const ang=-Math.PI/2+k*(Math.PI*2/5);
      const cx=Math.cos(ang)*r*0.56, cy=Math.sin(ang)*r*0.56;
      ctx.beginPath();
      for(let i=0;i<5;i++){
        const a=ang+(i*(Math.PI*2/5))+Math.PI/5;
        const px=cx+Math.cos(a)*r*0.19, py=cy+Math.sin(a)*r*0.19;
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      }
      ctx.closePath(); 
      ctx.fill(); 
      ctx.stroke();
    }

    ctx.globalAlpha=0.35;
    ctx.fillStyle="#fff";
    ctx.beginPath(); 
    ctx.arc(-r*0.35,-r*0.45,r*0.28,0,Math.PI*2); 
    ctx.fill();
    ctx.globalAlpha=1;

    ctx.restore();
  }

  function drawField(){
    ctx.fillStyle="#0a3a2b"; 
    ctx.fillRect(0,0,W,H);

    ctx.globalAlpha=0.12;
    for(let i=0;i<12;i++){
      ctx.fillStyle=(i%2===0)?"rgba(255,255,255,.8)":"rgba(0,0,0,.6)";
      ctx.fillRect(0,(H/12)*i,W,H/12);
    }
    ctx.globalAlpha=1;

    const g1=ctx.createRadialGradient(W/2,H*0.95,50,W/2,H*0.95,Math.max(W,H)*0.8);
    g1.addColorStop(0,"rgba(34,197,94,.22)");
    g1.addColorStop(1,"rgba(0,0,0,.35)");
    ctx.fillStyle=g1; 
    ctx.fillRect(0,0,W,H);

    const g2=ctx.createRadialGradient(W/2,H*0.05,50,W/2,H*0.05,Math.max(W,H)*0.6);
    g2.addColorStop(0,"rgba(59,130,246,.12)");
    g2.addColorStop(1,"transparent");
    ctx.fillStyle=g2; 
    ctx.fillRect(0,0,W,H);

    ctx.strokeStyle="rgba(255,255,255,.85)";
    ctx.lineWidth=2.5;
    ctx.shadowColor="rgba(255,255,255,.5)";
    ctx.shadowBlur=12;
    ctx.strokeRect(18,18,W-36,H-36);
    ctx.shadowBlur=0;

    ctx.globalAlpha=0.25;
    ctx.strokeStyle="rgba(255,255,255,.7)";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.arc(W/2, H/2, 50, 0, Math.PI*2);
    ctx.stroke();
    ctx.globalAlpha=1;
  }

  function rr(x,y,w,h,r){
    if(!ctx.roundRect){
      ctx.beginPath(); ctx.rect(x,y,w,h); return;
    }
    ctx.beginPath(); ctx.roundRect(x,y,w,h,r);
  }

  function drawGoalFrame({x,y,w,h,depth,flip,ripple=null,glow="rgba(255,255,255,.3)"}){
    ctx.save();

    ctx.globalAlpha=0.25;
    ctx.fillStyle="rgba(0,0,0,.75)";
    const dy = flip ? -depth : depth;
    const shadowOffset = flip ? -8 : 8;
    rr(x+8, y+h+dy+shadowOffset-8, w-16, 16, 12);
    ctx.fill();
    ctx.globalAlpha=1;

    ctx.shadowColor=glow;
    ctx.shadowBlur=16;
    ctx.lineWidth=5;
    ctx.strokeStyle="rgba(255,255,255,.98)";
    ctx.beginPath();
    ctx.moveTo(x, y+h);
    ctx.lineTo(x, y);
    ctx.lineTo(x+w, y);
    ctx.lineTo(x+w, y+h);
    ctx.stroke();
    
    ctx.shadowBlur=8;
    ctx.lineWidth=3;
    ctx.strokeStyle="rgba(255,255,255,.6)";
    ctx.stroke();
    ctx.shadowBlur=0;

    ctx.globalAlpha=0.28;
    ctx.lineWidth=1.2;
    ctx.strokeStyle="rgba(255,255,255,.7)";
    const step=10;
    const netTopY = flip ? (y+h-8) : (y+8);
    const netBotY = flip ? (y - depth) : (y+h+depth);

    for(let xx=x+12; xx<=x+w-12; xx+=step){
      const offset = ((xx-x)/(w))*12;
      ctx.beginPath();
      ctx.moveTo(xx, netTopY);
      ctx.lineTo(xx-offset, netBotY);
      ctx.stroke();
    }
    
    const total = h+depth;
    for(let i=0;i<=total;i+=step){
      ctx.beginPath();
      const yy = flip ? (y+h-i) : (y+i);
      const curve = Math.sin((i/total)*Math.PI)*4;
      ctx.moveTo(x+10, yy);
      ctx.quadraticCurveTo(x+w/2, yy-curve, x+w-10, yy);
      ctx.stroke();
    }
    ctx.globalAlpha=1;

    if(ripple){
      ctx.globalAlpha=Math.max(0, 0.75 - ripple.age*1.2);
      ctx.strokeStyle="rgba(34,197,94,.98)";
      ctx.lineWidth=3.5;
      ctx.shadowColor="rgba(34,197,94,.8)";
      ctx.shadowBlur=15;
      ctx.beginPath();
      ctx.arc(ripple.x, ripple.y, 12 + ripple.age*200, 0, Math.PI*2);
      ctx.stroke();
      
      ctx.globalAlpha=Math.max(0, 0.5 - ripple.age*1.4);
      ctx.lineWidth=2;
      ctx.shadowBlur=10;
      ctx.beginPath();
      ctx.arc(ripple.x, ripple.y, 25 + ripple.age*250, 0, Math.PI*2);
      ctx.stroke();
      
      ctx.globalAlpha=Math.max(0, 0.3 - ripple.age*1.6);
      ctx.lineWidth=1;
      ctx.shadowBlur=5;
      ctx.beginPath();
      ctx.arc(ripple.x, ripple.y, 40 + ripple.age*300, 0, Math.PI*2);
      ctx.stroke();
      
      ctx.shadowBlur=0;
      ctx.globalAlpha=1;
    }

    ctx.restore();
  }

  // ==================== Sizes ====================
  const S = {
    margin:18,
    soloGoalW:240,
    soloGoalH:56,
    soloGoalDepth:32,
    pvpGoalW:200,
    pvpGoalH:28,
    pvpGoalDepth:22,
  };
  function computeSizes(){
    S.margin = Math.max(16, Math.min(22, W*0.035));
    S.soloGoalW = clamp(W*0.56, 210, 280);
    S.soloGoalH = clamp(H*0.085, 46, 70);
    S.soloGoalDepth = clamp(W*0.075, 26, 40);
    S.pvpGoalW = clamp(W*0.48, 190, 260);
    S.pvpGoalH = clamp(H*0.06, 24, 44);
    S.pvpGoalDepth = clamp(W*0.06, 18, 32);
  }

  // ==================== Game State ====================
  const MODES={solo:"solo", pvp:"pvp"};
  let mode=MODES.solo;

  // -------------------- Solo (Penalty) --------------------
  const solo = {
    score:0, goals:0, streak:0, bestStreak:0, totalShots:0, accuracy:0,
    lastOutcome:"",
    ball:{x:0,y:0,r:10,vx:0,vy:0,spin:0,stuck:true,trail:[]},
    player:{x:0,y:0,r:18},
    keeper:{x:0,y:0,w:54,h:14,headR:8,targetX:0,react:0.55,diveT:0,saveCooldown:0,anticipation:0,_cx:0,_cy:0},
    ripple:null,
    particles:[],
    shotAge:0,
    resolving:false,
    _predictedAimX:null,
  };

  let soloNonGoalStreak=0;

  function soloResetShot(){
    solo.ball.stuck=true;
    solo.ball.vx=solo.ball.vy=0;
    solo.ball.spin=0;
    solo.ball.trail.length=0;
    solo.ball.x=solo.player.x;
    solo.ball.y=solo.player.y-(solo.player.r+solo.ball.r+6);

    solo.keeper.y=S.margin+62;
    solo.keeper.x=W/2;
    solo.keeper.targetX=W/2;
    solo.keeper.diveT=0;
    solo.keeper.saveCooldown=0;
    solo.keeper.anticipation=0;
    solo.keeper._cx=solo.keeper.x;
    solo.keeper._cy=solo.keeper.y;

    solo.ripple=null;
    solo.particles.length=0;
    solo.shotAge=0;
    solo.resolving=false;
  }

  function soloResetAll(){
    solo.score=0; solo.goals=0; solo.streak=0; solo.lastOutcome="";
    solo.bestStreak=0; solo.totalShots=0; solo.accuracy=0;
    soloNonGoalStreak=0;
    soloResetShot();
  }

  function keeperDifficulty(){
    const s = clamp(solo.streak,0,10);
    return {
      react: clamp(0.32 + s*0.025, 0.32, 0.55),
      chaos: clamp(22 - s*1.4, 4, 22),
      centerBias: clamp(0.32 + s*0.018, 0.32, 0.48),
      anticipation: clamp(s*0.06, 0, 0.65)
    };
  }

  function soloCommitDive(){
    const g = keeperDifficulty();
    solo.keeper.react = g.react;
    solo.keeper.anticipation = g.anticipation;

    const gx1=(W-S.soloGoalW)/2;
    const gx2=gx1+S.soloGoalW;

    const aim = solo._predictedAimX || (W/2);
    const spinEffect = Math.abs(solo.ball.spin) * 12;
    const curveNoise = (Math.random()*2-1) * (8 + spinEffect);
    const chaos = (Math.random()*2-1) * g.chaos;
    
    const anticipatedCurve = solo.ball.spin * 18 * g.anticipation;

    let predict = aim + chaos + curveNoise + anticipatedCurve;
    predict = clamp(predict, gx1+solo.keeper.w/2+16, gx2-solo.keeper.w/2-16);
    solo.keeper.targetX=predict;

    solo.keeper.saveCooldown=0.15;
  }

  function soloStepKeeper(dt){
    const k = clamp(dt*60, 0, 2.5);
    solo.keeper.x += (solo.keeper.targetX - solo.keeper.x) * solo.keeper.react * k;

    if(!solo.ball.stuck) solo.keeper.diveT = clamp(solo.keeper.diveT + 0.09*k, 0, 1);
    else                 solo.keeper.diveT = clamp(solo.keeper.diveT - 0.14*k, 0, 1);

    const dx = (solo.keeper.targetX - W/2) * 0.22 * solo.keeper.diveT;
    const dy = -solo.keeper.diveT * 12;
    solo.keeper._cx = solo.keeper.x + dx;
    solo.keeper._cy = solo.keeper.y + dy;
  }

  function spawnParticles(x,y,color="#22c55e",n=14){
    for(let i=0;i<n;i++){
      solo.particles.push({
        x,y,
        vx:(Math.random()*2-1)*3.2,
        vy:(Math.random()*2-1)*3.2,
        life:0,
        max:0.45+Math.random()*0.4,
        color,
        size:2+Math.random()*3
      });
    }
  }

  function updateParticles(dt){
    for(let i=solo.particles.length-1;i>=0;i--){
      const p=solo.particles[i];
      p.life+=dt;
      p.x+=p.vx*60*dt;
      p.y+=p.vy*60*dt;
      p.vx*=0.96;
      p.vy*=0.96;
      p.vy+=1.2*dt*60;
      if(p.life>=p.max) solo.particles.splice(i,1);
    }
  }

  function drawParticles(){
    for(const p of solo.particles){
      const a = 1 - (p.life/p.max);
      ctx.globalAlpha=a;
      ctx.fillStyle=p.color;
      ctx.beginPath();
      ctx.arc(p.x,p.y,p.size,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=1;
  }

  function updateTrail(){
    const b=solo.ball;
    b.trail.unshift({x:b.x,y:b.y,life:0});
    if(b.trail.length>10) b.trail.pop();
    for(const t of b.trail) t.life += 1;
  }
  function drawTrail(){
    const b=solo.ball;
    for(let i=0;i<b.trail.length;i++){
      const t=b.trail[i];
      const a = (1 - i/b.trail.length)*0.35;
      ctx.globalAlpha=a;
      ctx.fillStyle="rgba(255,255,255,.9)";
      ctx.beginPath();
      ctx.arc(t.x,t.y,b.r*(0.7 - i*0.03),0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=1;
  }

  function soloShoot(dx,dy,mag){
    if(!solo.ball.stuck || solo.resolving) return;
    solo.totalShots++;
    const strength = clamp(mag/110, 0, 1);
    if(strength<0.12){ hype("ğŸ‘† Ù…Ø­Ú©Ù…â€ŒØªØ± Ø¨Ú©Ø´!","neutral",650); return; }

    const angle = Math.atan2(dy,dx);
    const sp = 6.5 + strength*10;

    solo.ball.stuck=false;
    solo.ball.vx = -Math.cos(angle)*sp;
    solo.ball.vy = -Math.sin(angle)*sp;

    const side = clamp(dx/90, -1, 1);
    solo.ball.spin = side * (0.5 + strength*0.8);

    solo._predictedAimX = clamp(solo.ball.x + solo.ball.vx*14 + solo.ball.spin*120, 0, W);

    sfxKick(); vibr(18);

    setTimeout(()=>soloCommitDive(), 140 + (Math.random()*60));
  }

  function soloFinish(outcome){
    solo.resolving=true;
    solo.lastOutcome=outcome;
    setTimeout(()=>{ soloResetShot(); }, 520);
  }

  function soloUpdate(dt){
    solo.player.x=W/2;
    solo.player.y=H - S.margin - 52;

    if(solo.ball.stuck){
      solo.ball.x=solo.player.x;
      solo.ball.y=solo.player.y-(solo.player.r+solo.ball.r+6);
      solo._predictedAimX = null;
    }else{
      solo.shotAge += dt;

      // physics
      solo.ball.vy += 0.06*60*dt;                // gravity
      solo.ball.x  += solo.ball.vx*60*dt;
      solo.ball.y  += solo.ball.vy*60*dt;

      // curve (spin)
      solo.ball.vx += solo.ball.spin * 0.07*60*dt;
      solo.ball.spin *= 0.992;

      updateTrail();

      // walls
      if(solo.ball.x < solo.ball.r){ solo.ball.x=solo.ball.r; solo.ball.vx*=-0.7; }
      if(solo.ball.x > W-solo.ball.r){ solo.ball.x=W-solo.ball.r; solo.ball.vx*=-0.7; }
      if(solo.ball.y < solo.ball.r){ solo.ball.y=solo.ball.r; solo.ball.vy*=-0.7; }

      // goal geometry
      const gx1=(W-S.soloGoalW)/2;
      const gx2=gx1+S.soloGoalW;
      const gy=S.margin+40;
      const crossbarY = gy;
      const mouthY = gy + S.soloGoalH; // âœ… Ø¯Ù‡Ø§Ù†Ù‡â€ŒÛŒ ÙˆØ§Ù‚Ø¹ÛŒ (Ù„Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ† ÙØ±ÛŒÙ…)

      const postLx = gx1;
      const postRx = gx2;

      // keeper hitboxes
      const kx=solo.keeper._cx, ky=solo.keeper._cy;
      const body={x:kx-solo.keeper.w/2, y:ky-solo.keeper.h/2, w:solo.keeper.w, h:solo.keeper.h};
      const head={x:kx, y:ky-solo.keeper.h/2-solo.keeper.headR+2, r:solo.keeper.headR};

      // smarter post / bar collision (smaller tolerance + speed-aware)
      const speed = Math.hypot(solo.ball.vx, solo.ball.vy);
      const tol = clamp(2 + speed * 0.15, 2, 4);

      const nearX = (solo.ball.x >= postLx - 6 && solo.ball.x <= postRx + 6);
      const hitCrossbar = nearX && Math.abs((solo.ball.y - solo.ball.r) - crossbarY) < tol && solo.ball.vy < 0;

      const hitLeftPost  = Math.abs((solo.ball.x - solo.ball.r) - postLx) < tol &&
                           (solo.ball.y - solo.ball.r) < (crossbarY + S.soloGoalH - 6);

      const hitRightPost = Math.abs((solo.ball.x + solo.ball.r) - postRx) < tol &&
                           (solo.ball.y - solo.ball.r) < (crossbarY + S.soloGoalH - 6);

      if(hitCrossbar || hitLeftPost || hitRightPost){
        sfxPost(); vibr(14); hype("ğŸ¥¶ ØªÛŒØ± Ø¯Ø±ÙˆØ§Ø²Ù‡!","warn");
        solo.streak=0;
        soloNonGoalStreak++;
        if(soloNonGoalStreak>=2) showAd();

        if(hitCrossbar) solo.ball.vy = Math.abs(solo.ball.vy) * 0.72;
        if(hitLeftPost || hitRightPost) solo.ball.vx *= -0.82;

        soloFinish("post"); // âœ… Ø¯Ø±Ø³Øª
        return;
      }

      // keeper save
      const hitBody = circleRectHit(solo.ball.x,solo.ball.y,solo.ball.r, body.x,body.y,body.w,body.h);
      const hitHead = dist(solo.ball.x,solo.ball.y, head.x,head.y) <= (solo.ball.r+head.r);

      if(solo.keeper.saveCooldown<=0 && (hitBody || hitHead)){
        solo.streak=0;
        soloNonGoalStreak++;
        sfxSave(); vibr(20); hype("ğŸ§¤ Ø³ÛŒÙˆ ØªÙˆØ³Ø· Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù†!","warn");
        if(soloNonGoalStreak>=2) showAd();
        soloFinish("save");
        return;
      }

      // goal / miss line (we use mouthY as the goal line)
      const insideMouthX = (solo.ball.x >= gx1+8 && solo.ball.x <= gx2-8);
      const crossesMouth = (solo.ball.y - solo.ball.r) <= mouthY && solo.ball.vy < 0;

      const g = keeperDifficulty();
      const gxMid = gx1 + S.soloGoalW/2;
      const centerHard = Math.abs(solo.ball.x - gxMid) < (S.soloGoalW * g.centerBias);
      const strongEnough = speed > 4.2;

      if(crossesMouth){
        if(!insideMouthX){
          solo.streak=0;
          soloNonGoalStreak++;
          sfxMiss(); vibr(18); hype("ğŸ˜… Ø§ÙˆØª Ø´Ø¯!","bad");
          if(soloNonGoalStreak>=2) showAd();
          soloFinish("miss");
          return;
        }

        // weak central shots get punished (more realistic)
        if(centerHard && !strongEnough){
          solo.streak=0;
          soloNonGoalStreak++;
          sfxMiss(); hype("ğŸ’¨ Ø¶Ø¹ÛŒÙ Ø¨ÙˆØ¯!","bad");
          if(soloNonGoalStreak>=2) showAd();
          soloFinish("weak");
          return;
        }

        // strong but straight shots are more likely saved
        if(centerHard && strongEnough && solo.keeper.diveT>0.25){
          solo.streak=0;
          soloNonGoalStreak++;
          sfxSave(); hype("ğŸ§¤ Ø¯Ø±ÙˆØ§Ø²Ù‡â€ŒØ¨Ø§Ù† Ú¯Ø±ÙØª!","warn");
          if(soloNonGoalStreak>=2) showAd();
          soloFinish("center");
          return;
        }

        // âœ… GOAL
        solo.goals++;
        solo.streak++;
        solo.bestStreak=Math.max(solo.bestStreak, solo.streak);
        soloNonGoalStreak=0;

        const bonus = 10 + solo.streak*2;
        const cornerBonus = centerHard ? 0 : 6;
        solo.score += bonus + cornerBonus;

        solo.ripple={x:solo.ball.x,y:mouthY+10,age:0};
        spawnParticles(solo.ball.x, mouthY+10, "#22c55e", 22);

        const hypeText = solo.streak>=4 ? `ğŸ”¥ğŸ”¥ğŸ”¥ Ú¯Ù„! (${solo.streak}x)` : `âš½ Ú¯Ù„! +${bonus}`;
        goalHype(hypeText);
        if(solo.streak>=3) showCombo(`COMBO x${solo.streak}!`);

        soloFinish("goal");
        return;
      }

      // late / out
      if(solo.ball.y > H + 60){
        solo.streak=0;
        soloNonGoalStreak++;
        sfxMiss(); vibr(16); hype("ğŸ˜… Ø¯ÛŒØ± Ø´Ø¯!","bad");
        if(soloNonGoalStreak>=2) showAd();
        soloFinish("late");
        return;
      }
    }

    solo.keeper.saveCooldown = Math.max(0, solo.keeper.saveCooldown - dt);
    soloStepKeeper(dt);

    if(solo.ripple){
      solo.ripple.age += dt;
      if(solo.ripple.age>0.6) solo.ripple=null;
    }

    updateParticles(dt);

    if(solo.totalShots>0) solo.accuracy = Math.round((solo.goals/solo.totalShots)*100);
  }

  function soloDraw(drag){
    drawField();

    const gx1=(W-S.soloGoalW)/2;
    const gy=S.margin+40;
    drawGoalFrame({
      x:gx1, y:gy, w:S.soloGoalW, h:S.soloGoalH,
      depth:S.soloGoalDepth, flip:false,
      ripple:solo.ripple,
      glow:"rgba(34,197,94,.28)"
    });

    // keeper
    const k=solo.keeper;
    ctx.save();
    ctx.translate(k._cx, k._cy);
    
    ctx.globalAlpha=0.18;
    ctx.fillStyle="#000";
    ctx.beginPath(); 
    ctx.ellipse(0, k.h/2+6, k.w*0.5, 4, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.globalAlpha=1;
    
    const bodyGrad = ctx.createLinearGradient(0, -k.h/2, 0, k.h/2);
    bodyGrad.addColorStop(0, "rgba(34,197,94,.95)");
    bodyGrad.addColorStop(1, "rgba(22,163,74,.95)");
    ctx.fillStyle=bodyGrad;
    rr(-k.w/2, -k.h/2, k.w, k.h, 7);
    ctx.fill();
    
    ctx.fillStyle="rgba(255,255,255,.85)";
    ctx.font="bold 9px system-ui";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText("1", 0, 0);
    
    const headGrad = ctx.createRadialGradient(-k.headR*0.3, -k.h/2-k.headR-1, 0, 0, -k.h/2-k.headR+1, k.headR);
    headGrad.addColorStop(0, "#fef3c7");
    headGrad.addColorStop(1, "#fbbf24");
    ctx.fillStyle=headGrad;
    ctx.beginPath(); 
    ctx.arc(0, -k.h/2-k.headR+1, k.headR, 0, Math.PI*2); 
    ctx.fill();
    
    ctx.fillStyle="rgba(15,23,42,.65)";
    ctx.beginPath(); 
    ctx.arc(-2, -k.h/2-k.headR, 1.2, 0, Math.PI*2); 
    ctx.fill();
    ctx.beginPath(); 
    ctx.arc(2, -k.h/2-k.headR, 1.2, 0, Math.PI*2); 
    ctx.fill();
    
    ctx.globalAlpha=0.25;
    ctx.fillStyle="#fff";
    ctx.beginPath(); 
    ctx.arc(-k.w/2+3, 0, 3, 0, Math.PI*2); 
    ctx.fill();
    ctx.beginPath(); 
    ctx.arc(k.w/2-3, 0, 3, 0, Math.PI*2); 
    ctx.fill();
    ctx.globalAlpha=1;
    
    ctx.restore();

    // player base
    ctx.save();
    ctx.translate(solo.player.x, solo.player.y);
    ctx.fillStyle="rgba(59,130,246,.16)";
    ctx.beginPath(); ctx.arc(0,0,solo.player.r+8,0,Math.PI*2); ctx.fill();
    ctx.restore();

    if(!solo.ball.stuck) drawTrail();
    drawSoccerBall(solo.ball.x,solo.ball.y,solo.ball.r,solo.ball.spin);

    if(drag && drag.active && drag.start && drag.now){
      const dx=drag.start.x-drag.now.x;
      const dy=drag.start.y-drag.now.y;
      const mag=Math.hypot(dx,dy);
      const p=clamp(mag/110,0,1);
      ui.powerMeter.classList.add('show');
      ui.powerBar.style.width = `${Math.round(p*100)}%`;

      const ax=solo.ball.x, ay=solo.ball.y;
      const ang=Math.atan2(dy,dx);
      const len=40+p*45;
      ctx.save();
      ctx.translate(ax,ay);
      ctx.rotate(ang+Math.PI);
      ctx.globalAlpha=0.92;
      ctx.strokeStyle="rgba(255,255,255,.95)";
      ctx.lineWidth=3;
      ctx.beginPath();
      ctx.moveTo(0,0); ctx.lineTo(len,0);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(len,0); ctx.lineTo(len-12,6);
      ctx.lineTo(len-12,-6); ctx.closePath();
      ctx.fillStyle="rgba(255,255,255,.95)";
      ctx.fill();
      ctx.restore();

      const side=clamp(dx/90,-1,1);
      if(Math.abs(side)>0.35){
        ctx.save();
        ctx.globalAlpha=0.55;
        ctx.strokeStyle= side>0 ? "rgba(34,197,94,.95)" : "rgba(59,130,246,.95)";
        ctx.lineWidth=3;
        ctx.beginPath();
        ctx.arc(ax, ay-10, 26, side>0?0.2*Math.PI:0.8*Math.PI, side>0?1.15*Math.PI:1.8*Math.PI, side<0);
        ctx.stroke();
        ctx.restore();
      }
    }else{
      ui.powerMeter.classList.remove('show');
      ui.powerBar.style.width = '0%';
    }

    drawParticles();
  }

  // -------------------- PvP (Two players) --------------------
  const pvp = {
    s1:0,s2:0,maxGoals:4,
    ball:{x:0,y:0,r:10,vx:0,vy:0,spin:0,trail:[]},
    p1:{x:0,y:0,r:18,vx:0, color:"rgba(34,197,94,.95)"},
    p2:{x:0,y:0,r:18,vx:0, color:"rgba(59,130,246,.95)"},
    ripple:null,
    particles:[],
    lastTouch:null,
    touchCooldown:0,
  };

  function pvpResetAll(){
    pvp.s1=0; pvp.s2=0;
    pvp.ball.x=W/2; pvp.ball.y=H/2;
    pvp.ball.vx=pvp.ball.vy=0;
    pvp.ball.spin=0;
    pvp.ball.trail.length=0;
    pvp.p1.x=W/2; pvp.p1.y=H-80; pvp.p1.vx=0;
    pvp.p2.x=W/2; pvp.p2.y=80; pvp.p2.vx=0;
    pvp.ripple=null;
    pvp.particles.length=0;
    pvp.lastTouch=null;
    pvp.touchCooldown=0;
  }

  function pvpSpawnParticles(x,y,color="#22c55e",n=12){
    for(let i=0;i<n;i++){
      pvp.particles.push({
        x,y,
        vx:(Math.random()*2-1)*3.2,
        vy:(Math.random()*2-1)*3.2,
        life:0,
        max:0.45+Math.random()*0.4,
        color,
        size:2+Math.random()*3
      });
    }
  }
  function pvpUpdateParticles(dt){
    for(let i=pvp.particles.length-1;i>=0;i--){
      const p=pvp.particles[i];
      p.life+=dt;
      p.x+=p.vx*60*dt;
      p.y+=p.vy*60*dt;
      p.vx*=0.96; p.vy*=0.96;
      if(p.life>=p.max) pvp.particles.splice(i,1);
    }
  }
  function pvpDrawParticles(){
    for(const p of pvp.particles){
      const a = 1 - (p.life/p.max);
      ctx.globalAlpha=a;
      ctx.fillStyle=p.color;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
  }

  function pvpUpdate(dt){
    pvp.p1.y = H - S.margin - 56;
    pvp.p2.y = S.margin + 56;

    pvp.ball.vy += 0.03*60*dt;
    pvp.ball.x += pvp.ball.vx*60*dt;
    pvp.ball.y += pvp.ball.vy*60*dt;
    pvp.ball.vx += pvp.ball.spin * 0.04*60*dt;
    pvp.ball.spin *= 0.994;

    if(pvp.ball.x < pvp.ball.r){ pvp.ball.x=pvp.ball.r; pvp.ball.vx*=-0.85; }
    if(pvp.ball.x > W-pvp.ball.r){ pvp.ball.x=W-pvp.ball.r; pvp.ball.vx*=-0.85; }

    pvp.touchCooldown = Math.max(0, pvp.touchCooldown-dt);
    function collidePlayer(pl, id){
      if(pvp.touchCooldown>0) return false;
      const d = dist(pvp.ball.x,pvp.ball.y, pl.x,pl.y);
      if(d <= pl.r + pvp.ball.r + 4){
        const ang = Math.atan2(pvp.ball.y-pl.y, pvp.ball.x-pl.x);

        // âœ… Ø¶Ø±Ø¨Ù‡ Ø·Ø¨ÛŒØ¹ÛŒâ€ŒØªØ±: Ù‚Ø¯Ø±Øª ÙˆØ§Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ø³Ø±Ø¹Øª Ø¯Ø³Øª + Ú©Ù…ÛŒ ØªÙ†ÙˆØ¹
        const base = 5.6;
        const add = clamp(Math.abs(pl.vx)/900, 0, 1) * 4.8;
        const sp = base + add;

        pvp.ball.vx = Math.cos(ang)*sp;
        pvp.ball.vy = Math.sin(ang)*sp;

        // âœ… Ø§Ø³Ù¾ÛŒÙ† ÙˆØ§Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ø­Ø±Ú©Øª Ø¨Ø§Ø²ÛŒÚ©Ù† (Ú©Ù†ØªØ±Ù„â€ŒÙ¾Ø°ÛŒØ±)
        pvp.ball.spin += clamp(pl.vx/2200, -0.35, 0.35);

        // ÛŒÚ© ØªÙ„Ù†Ú¯Ø± Ú©ÙˆÚ†ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù‡ÛŒØ¬Ø§Ù†
        pvp.ball.spin += (Math.random()*2-1)*0.06;

        pvp.lastTouch=id;
        pvp.touchCooldown=0.085;

        // UI pulse Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ¨Øª/Ù„Ù…Ø³
        try{
          const pill = id===1 ? ui.p1Pill : ui.p2Pill;
          pill.classList.remove("pulse");
          void pill.offsetWidth;
          pill.classList.add("pulse");
          setTimeout(()=>pill.classList.remove("pulse"), 420);
        }catch(_){}

        sfxKick(); vibr(12);
        pvpSpawnParticles(pvp.ball.x,pvp.ball.y, id===1 ? "#22c55e" : "#3b82f6", 12);
        return true;
      }
      return false;
    }
    collidePlayer(pvp.p1,1);
    collidePlayer(pvp.p2,2);

    const g1x=(W-S.pvpGoalW)/2;
    const g2x=g1x+S.pvpGoalW;

    const topGoalY = S.margin+26;
    const botGoalY = H - S.margin - 26;

    if(pvp.ball.y - pvp.ball.r <= topGoalY && pvp.ball.vy<0){
      if(pvp.ball.x>=g1x+10 && pvp.ball.x<=g2x-10){
        pvp.s1++;
        goalHype("ğŸŸ¢ Ú¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† Û±!");
        if(ADS.showOnGoal) showAd();
        pvpResetBall();
        return;
      }else{
        sfxPost(); vibr(10); hype("ğŸ¥¶ ØªÛŒØ±Ú©!","warn");
        pvp.ball.vy*=-0.7;
      }
    }

    if(pvp.ball.y + pvp.ball.r >= botGoalY && pvp.ball.vy>0){
      if(pvp.ball.x>=g1x+10 && pvp.ball.x<=g2x-10){
        pvp.s2++;
        goalHype("ğŸ”µ Ú¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒÚ©Ù† Û²!");
        if(ADS.showOnGoal) showAd();
        pvpResetBall();
        return;
      }else{
        sfxPost(); vibr(10); hype("ğŸ¥¶ ØªÛŒØ±Ú©!","warn");
        pvp.ball.vy*=-0.7;
      }
    }

    // Ø¯ÛŒÙˆØ§Ø± Ù†Ø±Ù… Ø¨Ø§Ù„Ø§/Ù¾Ø§ÛŒÛŒÙ† (Ø¨Ù‡â€ŒØ¬Ø² Ø¯Ù‡Ø§Ù†Ù‡â€ŒÛŒ Ú¯Ù„) ØªØ§ Ø¨Ø§Ø²ÛŒ Ø§Ø² ØµÙØ­Ù‡ ÙØ±Ø§Ø± Ù†Ú©Ù†Ø¯
    const mouthL = g1x+10, mouthR = g2x-10;

    if(pvp.ball.y - pvp.ball.r < S.margin+8 && pvp.ball.vy < 0){
      if(!(pvp.ball.x>=mouthL && pvp.ball.x<=mouthR)){
        pvp.ball.y = S.margin+8 + pvp.ball.r;
        pvp.ball.vy *= -0.78;
      }
    }
    if(pvp.ball.y + pvp.ball.r > H - (S.margin+8) && pvp.ball.vy > 0){
      if(!(pvp.ball.x>=mouthL && pvp.ball.x<=mouthR)){
        pvp.ball.y = H - (S.margin+8) - pvp.ball.r;
        pvp.ball.vy *= -0.78;
      }
    }

    if(pvp.s1>=pvp.maxGoals || pvp.s2>=pvp.maxGoals){
      running=false; paused=true; inEndScreen=true;
      const win = pvp.s1>pvp.s2 ? "ğŸŸ¢ Ø¨Ø§Ø²ÛŒÚ©Ù† Û± Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!" : "ğŸ”µ Ø¨Ø§Ø²ÛŒÚ©Ù† Û² Ø¨Ø±Ù†Ø¯Ù‡ Ø´Ø¯!";
      openOverlay("Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§Ø²ÛŒ ğŸ", win, "end");
      if(ADS.showOnWin) showAd();
    }

    pvpUpdateParticles(dt);

    if(pvp.ball.y > H + 80 || pvp.ball.y < -80){
      pvpResetBall();
    }
  }

  function pvpResetBall(){
    pvp.ball.x=W/2; pvp.ball.y=H/2;
    pvp.ball.vx=(Math.random()*2-1)*1.5;
    pvp.ball.vy=(Math.random()*2-1)*1.5;
    pvp.ball.spin=0;
    pvp.ball.trail.length=0;
  }

  function pvpDraw(){
    drawField();

    const gx1=(W-S.pvpGoalW)/2;
    const topY = S.margin+26;
    const botY = H - S.margin - 26 - S.pvpGoalH;

    drawGoalFrame({x:gx1,y:topY,w:S.pvpGoalW,h:S.pvpGoalH,depth:S.pvpGoalDepth,flip:true,glow:"rgba(255,255,255,.22)"});
    drawGoalFrame({x:gx1,y:botY,w:S.pvpGoalW,h:S.pvpGoalH,depth:S.pvpGoalDepth,flip:false,glow:"rgba(255,255,255,.22)"});

    function drawPlayer(pl){
      ctx.save();
      ctx.translate(pl.x,pl.y);
      ctx.fillStyle=pl.color;
      ctx.globalAlpha=0.22;
      ctx.beginPath(); ctx.arc(0,0,pl.r+10,0,Math.PI*2); ctx.fill();
      ctx.globalAlpha=1;
      ctx.fillStyle="rgba(255,255,255,.92)";
      ctx.beginPath(); ctx.arc(0,0,pl.r,0,Math.PI*2); ctx.fill();
      ctx.fillStyle="rgba(15,23,42,.75)";
      ctx.beginPath(); ctx.arc(0,0,pl.r-6,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }
    drawPlayer(pvp.p1);
    drawPlayer(pvp.p2);

    drawSoccerBall(pvp.ball.x,pvp.ball.y,pvp.ball.r,pvp.ball.spin);

    pvpDrawParticles();
  }

  // ==================== Input ====================
  const pointers=new Map();
  let drag={active:false,start:null,now:null};
  const TOUCH_ROLE = {p1:false,p2:false};
  let lastMoveT1 = performance.now();
  let lastMoveT2 = performance.now();

  cv.addEventListener("pointerdown",(e)=>{
    cv.setPointerCapture(e.pointerId);
    pointers.set(e.pointerId, {x:e.clientX,y:e.clientY});
    if(mode===MODES.solo){
      const p=toLocal(e);
      const d=dist(p.x,p.y, solo.ball.x,solo.ball.y);
      if(d<=solo.ball.r+18 && solo.ball.stuck){
        drag.active=true;
        drag.start=p;
        drag.now=p;
      }
      return;
    }

    const p=toLocal(e);
    if(p.y>H/2) { TOUCH_ROLE.p1=true; TOUCH_ROLE.p2=false; }
    else { TOUCH_ROLE.p2=true; TOUCH_ROLE.p1=false; }
  });

  cv.addEventListener("pointermove",(e)=>{
    if(!pointers.has(e.pointerId)) return;
    pointers.set(e.pointerId, {x:e.clientX,y:e.clientY});
    if(mode===MODES.solo){
      if(!drag.active) return;
      drag.now=toLocal(e);
      return;
    }
    const p=toLocal(e);
    if(TOUCH_ROLE.p1){
      const nowT = performance.now();
      const dtm = Math.max(0.016, (nowT-lastMoveT1)/1000);
      const prevX = pvp.p1.x;
      const newX = clamp(p.x, 20, W-20);
      pvp.p1.x = newX;
      pvp.p1.vx = (newX - prevX) / dtm;
      lastMoveT1 = nowT;
    }else if(TOUCH_ROLE.p2){
      const nowT = performance.now();
      const dtm = Math.max(0.016, (nowT-lastMoveT2)/1000);
      const prevX = pvp.p2.x;
      const newX = clamp(p.x, 20, W-20);
      pvp.p2.x = newX;
      pvp.p2.vx = (newX - prevX) / dtm;
      lastMoveT2 = nowT;
    }
  });

  function endPointer(pid){
    pointers.delete(pid);
    try{ cv.releasePointerCapture(pid); }catch(_){}
  }

  cv.addEventListener("pointerup",(e)=>{
    if(mode===MODES.solo){
      if(!drag.active) return;
      drag.active=false;
      
      ui.powerMeter.classList.remove('show');
      ui.powerBar.style.width = '0%';

      const end=toLocal(e);
      drag.now=end;

      const dx = (drag.start.x - end.x);
      const dy = (drag.start.y - end.y);
      const mag = Math.hypot(dx,dy);

      drag.start=null;
      soloShoot(dx,dy,mag);
      return;
    }
    endPointer(e.pointerId);
    TOUCH_ROLE.p1=false; TOUCH_ROLE.p2=false;
    pvp.p1.vx*=0.3; pvp.p2.vx*=0.3;
  });

  cv.addEventListener("pointercancel",(e)=>{
    drag.active=false; drag.start=null; drag.now=null;
    ui.powerMeter.classList.remove('show');
    ui.powerBar.style.width = '0%';
    endPointer(e.pointerId);
  });

  // ==================== Mode & UI ====================
  function syncUI(){
    ui.pauseBtn.textContent = paused ? "â–¶ï¸" : "â¸";
    ui.soundBtn.textContent = soundOn ? "ğŸ”Š" : "ğŸ”‡";
    ui.time.textContent = String(Math.max(0, Math.ceil(timeLeft)));

    if(mode===MODES.solo){
      ui.modeLabel.textContent="Ù¾Ù†Ø§Ù„ØªÛŒ";
      ui.p2Pill.style.display="none";
      ui.streakPill.style.display="";
      ui.p1Pill.querySelector(".tiny").textContent="Ø§Ù…ØªÛŒØ§Ø²";
      ui.p1Score.textContent = String(solo.score);
      ui.goals.textContent = String(solo.goals);
      ui.streak.textContent = String(solo.streak);
    }else{
      ui.modeLabel.textContent="Ø¯ÙˆÙ†ÙØ±Ù‡";
      ui.p2Pill.style.display="";
      ui.streakPill.style.display="none";
      ui.p1Pill.querySelector(".tiny").textContent="Ø¨Ø§Ø²ÛŒÚ©Ù† Û±";
      ui.p1Score.textContent = String(pvp.s1);
      ui.p2Score.textContent = String(pvp.s2);
      ui.goals.textContent = String(pvp.s1 + pvp.s2);
    }
  }

  function setMode(m){
    mode=m;

    // PvP Ø±Ø§ Ø¨Ù‡ Ø­Ø§Ù„Øª ØªÙ…Ø§Ù…â€ŒØµÙØ­Ù‡ Ø¨Ø¨Ø± (Ø¨Ø¯ÙˆÙ† Ø®Ø±Ø§Ø¨ Ú©Ø±Ø¯Ù† ØªØ¨Ù„ÛŒØºØ§Øª/Ø§ÛŒØªØ§)
    if(m===MODES.pvp) enterPvpFullscreen();
    else exitPvpFullscreen();

    ui.modeBtns.forEach(b=>b.classList.toggle("active", b.dataset.mode===m));
    paused=false; running=true; inEndScreen=false;
    closeOverlay(); hideAd();

    timeLeft=60;

    if(mode===MODES.solo){
      soloResetAll();
      ui.hint.textContent = "Ø±ÙˆÛŒ ØªÙˆÙ¾ Ø¨Ú©Ø´ Ùˆ Ø±Ù‡Ø§ Ú©Ù† ğŸ¯ Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¨Ù‡ØªØ±ÛŒÙ† Ù‡Ø¯Ù!";
      toast("ğŸ¯ Ø­Ø§Ù„Øª Ù¾Ù†Ø§Ù„ØªÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯");
    }else{
      pvpResetAll();
      ui.hint.textContent = `ğŸ‘¥ Ø¯ÙˆÙ†ÙØ±Ù‡: ğŸŸ¢ Ù¾Ø§ÛŒÛŒÙ† Ú©Ù†ØªØ±Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ù‡ / ğŸ”µ Ø¨Ø§Ù„Ø§. Ø§ÙˆÙ„ÛŒÙ† Ù†ÙØ± Ø¨Ù‡ ${pvp.maxGoals} Ú¯Ù„ Ø¨Ø±Ù†Ø¯Ù‡! ğŸ†`;
      toast("ğŸ‘¥ Ø­Ø§Ù„Øª Ø¯ÙˆÙ†ÙØ±Ù‡ ÙØ¹Ø§Ù„ Ø´Ø¯");
    }
    syncUI();
  }

  ui.modeBtns.forEach(b=>b.addEventListener("click", ()=>setMode(b.dataset.mode)));

  ui.restartBtn.addEventListener("click", ()=>{
    resize();
    setMode(mode);
  });

  // ==================== Timer / End ====================
  let timeLeft=60;
  function endByTime(){
    running=false; paused=true; inEndScreen=true;

    if(mode===MODES.solo){
      const msg = `Ø§Ù…ØªÛŒØ§Ø²: ${solo.score} | Ú¯Ù„â€ŒÙ‡Ø§: ${solo.goals} | Ø§Ø³ØªØ±ÛŒÚ© Ø¨Ù‡ØªØ±ÛŒÙ†: ${solo.bestStreak}`;
      openOverlay("Ù¾Ø§ÛŒØ§Ù† Ø²Ù…Ø§Ù† â±ï¸", msg, "end");
      if(ADS.showOnTimeEnd) showAd();
    }else{
      const msg = `Ù†ØªÛŒØ¬Ù‡: ${pvp.s1} - ${pvp.s2}`;
      openOverlay("Ù¾Ø§ÛŒØ§Ù† Ø²Ù…Ø§Ù† â±ï¸", msg, "end");
      if(ADS.showOnTimeEnd) showAd();
    }
  }

  // ==================== Loop ====================
  let lastT=performance.now();
  function tick(now){
    const dt = Math.min(0.033, (now-lastT)/1000) * slowmo;
    lastT=now;

    if(running && !paused){
      timeLeft -= dt;
      if(timeLeft<=0){ timeLeft=0; endByTime(); }

      if(mode===MODES.solo) soloUpdate(dt);
      else pvpUpdate(dt);
      syncUI();
    }

    ctx.clearRect(0,0,W,H);
    if(mode===MODES.solo) soloDraw(drag);
    else pvpDraw();

    requestAnimationFrame(tick);
  }

  // ==================== Boot ====================
  resize();
  setMode(MODES.solo);
  requestAnimationFrame(tick);

})();
</script>
</body>
</html>
